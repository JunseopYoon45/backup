CREATE OR REPLACE PROCEDURE DWSCM.SP_BF_DELETE_OLD_DATA 
(
	  P_BUKT				IN VARCHAR2
	, P_RT_ROLLBACK_FLAG	OUT VARCHAR2   
    , P_RT_MSG				OUT VARCHAR2
)
IS
	a VARCHAR2(20);
	b VARCHAR2(200);
	c VARCHAR2(50);
	w_COUNT NUMBER;
	v_VER_CD VARCHAR2(100);

BEGIN
	
	SELECT COUNT(*) INTO w_COUNT
	  FROM (SELECT DISTINCT VER_CD
			  FROM TB_BF_CONTROL_BOARD_VER_DTL
			 WHERE VER_CD LIKE 'BF-%'
			   AND CREATE_DTTM BETWEEN TRUNC(SYSDATE, 'IW') - 100 AND TRUNC(SYSDATE, 'IW') - 97);
	
		IF P_BUKT = 'W' THEN
			FOR I IN 1..w_COUNT
			LOOP
				/* 삭제 대상 버전코드 */
				SELECT VER_CD
				INTO v_VER_CD
				FROM (SELECT VER_CD
						   , ROW_NUMBER() OVER (ORDER BY VER_CD ASC) AS RW
						FROM (SELECT DISTINCT VER_CD 
								FROM TB_BF_CONTROL_BOARD_VER_DTL
							   WHERE VER_CD LIKE 'BF-%'
							   AND CREATE_DTTM BETWEEN TRUNC(SYSDATE, 'IW') - 100 AND TRUNC(SYSDATE, 'IW') - 97))
					WHERE RW = I;
	
			/* 주 단위 예측 결과 삭제 */
			DELETE FROM TB_BF_RT
			 WHERE VER_CD = v_VER_CD;
			
			COMMIT;
		
			/* 주 단위 예측 정확도 삭제 */
			DELETE FROM TB_BF_RT_ACCRCY
			 WHERE VER_CD = v_VER_CD;
			
			COMMIT;
		
			/* 주 단위 예측 최종 결과 삭제 */
			DELETE FROM TB_BF_RT_FINAL
			 WHERE VER_CD = v_VER_CD;
			
			COMMIT;
		
			/* 주 단위 소분류 예측 집계결과 삭제 */
			DELETE FROM TB_BF_RT_AGG
			 WHERE VER_CD = v_VER_CD;
			
			COMMIT;
		
			/* 주 단위 예측 최종 보정 후 결과 삭제 */					 
			DELETE FROM TB_BF_RT_FINAL_ADJ
			 WHERE VER_CD = v_VER_CD;
			
			COMMIT;
		
			/* 신상품 예측 결과 삭제 */					 
			DELETE FROM TB_BF_RT_FINAL_NEW
			 WHERE VER_CD = v_VER_CD;
			
			COMMIT;
	
		END LOOP;
	ELSE
		SELECT DISTINCT VER_CD INTO v_VER_CD
			  FROM TB_BF_CONTROL_BOARD_VER_DTL
			 WHERE VER_CD LIKE 'BFM-%'
			 AND TRUNC(CREATE_DTTM, 'MM') = ADD_MONTHS(TRUNC(TO_DATE(SYSDATE, 'YYYY-MM-DD'), 'MM'), -4)
			ORDER BY 1 DESC; 
		
		/* 월 단위 예측 결과 삭제 */	
		DELETE FROM TB_BF_RT_M
		 WHERE VER_CD = v_VER_CD
		 
		COMMIT;
	
		/* 월 단위 예측 정확도 삭제 */	
		DELETE FROM TB_BF_RT_ACCRCY_M
		 WHERE VER_CD = v_VER_CD
		 
		COMMIT;
	
		/* 월 단위 예측 최종 결과 삭제 */	
		DELETE FROM TB_BF_RT_FINAL_M
		 WHERE VER_CD = v_VER_CD
		 
		COMMIT;	
	
		/* 월 단위 예측 보정 후 결과 삭제 */	
		DELETE FROM TB_BF_RT_FINAL_M_ADJ
		 WHERE VER_CD = v_VER_CD
		 
		COMMIT;	
	
		/* 월 단위 예측 히스토리 삭제 */	
		DELETE FROM TB_BF_RT_HISTORY_M
		 WHERE VER_CD = v_VER_CD
		 
		COMMIT;	
	END IF;

	EXCEPTION WHEN OTHERS THEN
		ROLLBACK;
	
		a := SQLCODE;
		b := SQLERRM;
		c := SYS.dbms_utility.format_error_backtrace;
	
		BEGIN
			INSERT INTO TB_SCM100M_ERR_LOG(ERR_FILE, ERR_CODE, ERR_MSG, ERR_LINE, ERR_DTTM)
			SELECT 'SP_BF_DELETE_OLD_DATA', a, b, c, SYSDATE FROM DUAL;
		
			COMMIT;
		END;       
END;