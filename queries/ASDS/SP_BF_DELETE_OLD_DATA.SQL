CREATE OR REPLACE PROCEDURE DWSCM.SP_BF_DELETE_OLD_DATA 
(
	  P_BUKT				IN VARCHAR2
	, P_RT_ROLLBACK_FLAG	OUT VARCHAR2   
    , P_RT_MSG				OUT VARCHAR2
)
IS
	a VARCHAR2(20);
	b VARCHAR2(200);
	c VARCHAR2(50);
BEGIN
	
	IF P_BUKT = 'W' THEN
		/* 주 단위 예측 결과 삭제 */
		DELETE FROM TB_BF_RT
		 WHERE VER_CD IN (SELECT DISTINCT VER_CD
							FROM TB_BF_CONTROL_BOARD_VER_DTL
						   WHERE VER_CD LIKE 'BF-%'
							  AND CREATE_DTTM <= TRUNC(SYSDATE, 'IW') - 91);
		COMMIT;
	
		/* 주 단위 예측 정확도 삭제 */
		DELETE FROM TB_BF_RT_ACCRCY
		 WHERE VER_CD IN (SELECT DISTINCT VER_CD
							FROM TB_BF_CONTROL_BOARD_VER_DTL
						   WHERE VER_CD LIKE 'BF-%'
							  AND CREATE_DTTM <= TRUNC(SYSDATE, 'IW') - 91);
		COMMIT;
	
		/* 주 단위 예측 최종 결과 삭제 */
		DELETE FROM TB_BF_RT_FINAL
		 WHERE VER_CD IN (SELECT DISTINCT VER_CD
							FROM TB_BF_CONTROL_BOARD_VER_DTL
						   WHERE VER_CD LIKE 'BF-%'
							  AND CREATE_DTTM <= TRUNC(SYSDATE, 'IW') - 91);
		COMMIT;
	
		/* 주 단위 소분류 예측 집계결과 삭제 */
		DELETE FROM TB_BF_RT_AGG
		 WHERE VER_CD IN (SELECT DISTINCT VER_CD
							FROM TB_BF_CONTROL_BOARD_VER_DTL
						   WHERE VER_CD LIKE 'BF-%'
							  AND CREATE_DTTM <= TRUNC(SYSDATE, 'IW') - 91);
		COMMIT;
	
		/* 주 단위 예측 최종 보정 후 결과 삭제 */					 
		DELETE FROM TB_BF_RT_FINAL_ADJ
		 WHERE VER_CD IN (SELECT DISTINCT VER_CD
							FROM TB_BF_CONTROL_BOARD_VER_DTL
						   WHERE VER_CD LIKE 'BF-%'
							  AND CREATE_DTTM <= TRUNC(SYSDATE, 'IW') - 91);				
		COMMIT;
	
		/* 신상품 예측 결과 삭제 */					 
		DELETE FROM TB_BF_RT_FINAL_NEW
		 WHERE VER_CD IN (SELECT DISTINCT VER_CD
							FROM TB_BF_CONTROL_BOARD_VER_DTL
						   WHERE VER_CD LIKE 'BF-%'
							  AND CREATE_DTTM <= TRUNC(SYSDATE, 'IW') - 91);											 
		COMMIT;
	
	ELSE
		/* 월 단위 예측 결과 삭제 */	
		DELETE FROM TB_BF_RT_M
		 WHERE VER_CD IN (SELECT DISTINCT VER_CD
							FROM TB_BF_CONTROL_BOARD_VER_DTL
						   WHERE VER_CD LIKE 'BFM-%'
							 AND TRUNC(CREATE_DTTM, 'MM') <= ADD_MONTHS(SYSDATE, -3));
		COMMIT;
	
		/* 월 단위 예측 정확도 삭제 */	
		DELETE FROM TB_BF_RT_ACCRCY_M
		 WHERE VER_CD IN (SELECT DISTINCT VER_CD
							FROM TB_BF_CONTROL_BOARD_VER_DTL
						   WHERE VER_CD LIKE 'BFM-%'
							 AND TRUNC(CREATE_DTTM, 'MM') <= ADD_MONTHS(SYSDATE, -3));
		COMMIT;
	
		/* 월 단위 예측 최종 결과 삭제 */	
		DELETE FROM TB_BF_RT_FINAL_M
		 WHERE VER_CD IN (SELECT DISTINCT VER_CD
							FROM TB_BF_CONTROL_BOARD_VER_DTL
						   WHERE VER_CD LIKE 'BFM-%'
							 AND TRUNC(CREATE_DTTM, 'MM') <= ADD_MONTHS(SYSDATE, -3));
		COMMIT;	
	
		/* 월 단위 예측 보정 후 결과 삭제 */	
		DELETE FROM TB_BF_RT_FINAL_M_ADJ
		 WHERE VER_CD IN (SELECT DISTINCT VER_CD
							FROM TB_BF_CONTROL_BOARD_VER_DTL
						   WHERE VER_CD LIKE 'BFM-%'
							 AND TRUNC(CREATE_DTTM, 'MM') <= ADD_MONTHS(SYSDATE, -3));
		COMMIT;	
	
		/* 월 단위 예측 히스토리 삭제 */	
		DELETE FROM TB_BF_RT_HISTORY_M
		 WHERE VER_CD IN (SELECT DISTINCT VER_CD
							FROM TB_BF_CONTROL_BOARD_VER_DTL
						   WHERE VER_CD LIKE 'BFM-%'
							 AND TRUNC(CREATE_DTTM, 'MM') <= ADD_MONTHS(SYSDATE, -3));
		COMMIT;	
	END IF;

	EXCEPTION WHEN OTHERS THEN
		ROLLBACK;
	
		a := SQLCODE;
		b := SQLERRM;
		c := SYS.dbms_utility.format_error_backtrace;
	
		BEGIN
			INSERT INTO TB_SCM100M_ERR_LOG(ERR_FILE, ERR_CODE, ERR_MSG, ERR_LINE, ERR_DTTM)
			SELECT 'SP_BF_DELETE_OLD_DATA', a, b, c, SYSDATE FROM DUAL;
		
			COMMIT;
		END;       
END;